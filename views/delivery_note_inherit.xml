<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- 
        DELIVERY NOTE TEMPLATE INHERITANCE FOR SPACEY LAYOUT
        
        This file inherits the standard Odoo delivery note template to customize
        the formatting and positioning of delivery note-specific elements when
        using the Spacey Layout.
        
        Original template: stock.report_delivery_document
        Location: /usr/lib/python3/dist-packages/odoo/addons/stock/report/report_deliveryslip.xml
        
        =====================================================================
        CONFLICT RESOLUTION STRATEGY
        =====================================================================
        
        Problem: Multiple OCA and community modules also inherit the same template:
        - stock_picking_group_by_partner_by_carrier (groups deliveries)
        - stock_picking_line_sequence (adds sequence numbers)
        - stock_secondary_unit (adds secondary UoM columns)
        - partner_delivery_zone (adds delivery zone info)
        - And many others...
        
        These modules can cause XPath conflicts where our selectors no longer
        match the modified DOM structure, resulting in:
        - Document titles not being hidden (duplication)
        - Partner addresses not being hidden (duplication)
        - Information sections not being replaced correctly
        
        Solution Strategy (Multi-layered approach):
        1. HIGH TEMPLATE PRIORITY (priority="99") - Load after other modules
        2. ROBUST XPATH EXPRESSIONS - Multiple fallback selectors
        3. CSS FALLBACKS - !important styles to override any conflicts
        4. MODULE SEQUENCE - High sequence in manifest for load order
        
        This ensures our Spacey Layout works regardless of which other
        stock/delivery modules are installed in the system.
        -->
        
        <!-- 
        TEMPLATE INHERITANCE WITH HIGH PRIORITY
        
        Priority="99" ensures this template loads AFTER other conflicting modules:
        - stock_picking_group_by_partner_by_carrier (priority not set, default ~16)
        - stock_picking_line_sequence (priority not set, default ~16)
        - stock_secondary_unit (priority="8")
        - Other OCA stock workflow modules
        
        Higher priority numbers = loads later = takes precedence over earlier templates
        This prevents XPath conflicts caused by other modules modifying the same template
        -->
        <template id="report_delivery_document_spacey" inherit_id="stock.report_delivery_document" priority="99">
            
            <!-- CHANGE LAYOUT TO SPACEY -->
            <!-- Replace web.external_layout with our Spacey Layout -->
            <xpath expr="//t[@t-call='web.external_layout']" position="attributes">
                <attribute name="t-call">dh_efficient_layout.external_layout_spacey</attribute>
            </xpath>
            
            <!-- DISABLE OLD ADDRESS SECTION -->
            <!-- Note: Address xpath removed for compatibility - addresses handled in Spacey Layout header -->
            
            <!-- STYLE TABLE HEADERS WITH BOLD LINES -->
            <!-- Add bold borders to table headers like Subtotal/Total -->
            <xpath expr="//table[contains(@class,'table')]//thead//tr" position="attributes">
                <attribute name="style">border-top: 2px solid #000; border-bottom: 2px solid #000;</attribute>
            </xpath>
            
            <!-- STYLE TABLE HEADER CELLS -->
            <!-- Make header text bold and add padding -->
            <xpath expr="//table[contains(@class,'table')]//thead//th" position="attributes">
                <attribute name="style">font-weight: bold; padding: 10px 8px; background-color: #f8f9fa;</attribute>
            </xpath>
            
            <!-- 
            CUSTOMIZE DELIVERY NOTE INFORMATION SECTION
            
            Original Odoo Layout Problems:
            - Basic 2-column layout with minimal styling
            - No visual hierarchy or professional borders
            - Limited space utilization
            - Inconsistent field presentation
            
            Our Spacey Layout Improvements:
            - Professional 4-column responsive grid
            - Company-branded borders and colors (#2C5282)
            - Enhanced typography with proper sizing
            - Efficient use of horizontal space
            - Smart conditional column filling
            - State-aware date labeling (Done vs Scheduled)
            
            Target: Replaces the row containing div_origin and div_sched_date
            These are the original "Order" and "Shipping Date" fields
            -->
            <xpath expr="//div[div[@name='div_origin'] or div[@name='div_sched_date']]" position="replace">
                <div id="informations" class="mt16 mb16" style="border-top: 1px solid #2C5282; border-bottom: 1px solid #2C5282; padding: 12px 0;">
                    
                    <!-- FIRST ROW: Source Order | Value | Shipping Date | Value -->
                    <div class="row mb-2" t-if="o.origin or o.state">
                        <!-- Source Order Label -->
                        <div class="col-3" t-if="o.origin">
                            <strong style="color: #2C5282; font-size: 15px;">Source Order:</strong>
                        </div>
                        <!-- Source Order Value -->
                        <div class="col-3" t-if="o.origin">
                            <span style="font-size: 15px;" t-field="o.origin"/>
                        </div>
                        
                        <!-- Shipping Date Label -->
                        <div class="col-3" t-if="o.state">
                            <strong style="color: #2C5282; font-size: 15px;">Shipping Date:</strong>
                        </div>
                        <!-- Shipping Date Value -->
                        <div class="col-3" t-if="o.state">
                            <span style="font-size: 15px;">
                                <t t-if="o.state == 'done'">
                                    <span t-field="o.date_done"/>
                                </t>
                                <t t-if="o.state != 'done'">
                                    <span t-field="o.scheduled_date"/>
                                </t>
                            </span>
                        </div>
                        
                        <!-- Fill remaining columns if only one field exists -->
                        <div class="col-6" t-if="o.origin and not o.state"></div>
                        <div class="col-6" t-if="not o.origin and o.state"></div>
                    </div>
                    
                    <!-- SECOND ROW: Destination Address (spans full width) -->
                    <div class="row" t-if="o.partner_id">
                        <div class="col-3">
                            <strong style="color: #2C5282; font-size: 15px;">Destination:</strong>
                        </div>
                        <div class="col-9">
                            <span style="font-size: 15px;">
                                <span t-field="o.partner_id.name"/><t t-if="o.partner_id.street">, <span t-field="o.partner_id.street"/></t><t t-if="o.partner_id.street2">, <span t-field="o.partner_id.street2"/></t><t t-if="o.partner_id.city">, <span t-field="o.partner_id.city"/></t><t t-if="o.partner_id.state_id"> <span t-field="o.partner_id.state_id.name"/></t><t t-if="o.partner_id.zip"> <span t-field="o.partner_id.zip"/></t><t t-if="o.partner_id.country_id">, <span t-field="o.partner_id.country_id.name"/></t>
                            </span>
                        </div>
                    </div>
                    
                </div>
            </xpath>
            
            <!-- 
            REMOVE ORIGINAL DELIVERY NOTE TITLE
            
            Problem: The original Odoo template shows the document name/title in the body,
            but our Spacey Layout already displays it in the header. This creates duplication.
            
            Challenge: Other modules (like stock_picking_group_by_partner_by_carrier) may
            modify the document structure, making simple XPath expressions fail.
            
            Solution: Multiple fallback approaches to ensure title is hidden regardless
            of which modules are installed.
            -->
            
            <!-- PRIMARY: Target specific h2 with delivery note name -->
            <xpath expr="//div[@class='page']//h2[contains(.,'o.name') or span[@t-field='o.name']]" position="attributes">
                <attribute name="style">display: none;</attribute>
            </xpath>
            
            <!-- SECONDARY FALLBACK: Hide any h2 in the page content area -->
            <!-- This catches cases where other modules change the h2 structure -->
            <xpath expr="//div[@class='page']//h2" position="attributes">
                <attribute name="t-if">not (o and o.name)</attribute>
            </xpath>
            
            <!-- 
            HIDE PARTNER ADDRESS SECTIONS FROM CONFLICTING MODULES
            
            Problem: Some modules add partner address information in the document body,
            which conflicts with our Spacey Layout header that already shows this info.
            
            Common conflicting elements:
            - t[@name='partner_header'] from base stock template
            - t[@t-call='web.address_layout'] from various address display modules
            - Custom address widgets from OCA modules
            
            Solution: Disable these elements to prevent address duplication
            -->
            
            <!-- Hide the partner header section from base template -->
            <xpath expr="//t[@name='partner_header']" position="attributes">
                <attribute name="style">display: none;</attribute>
            </xpath>
            
            <!-- Disable web.address_layout calls that show partner info -->
            <xpath expr="//t[@t-call='web.address_layout']" position="attributes">
                <attribute name="t-if">False</attribute>
            </xpath>
            
            <!-- 
            CSS FALLBACK METHOD FOR MAXIMUM COMPATIBILITY
            
            Problem: XPath expressions may fail if conflicting modules significantly
            alter the document structure. Even with high priority, some elements
            might still appear if other modules use different approaches.
            
            Solution: CSS-based hiding with !important declarations to override
            any styling from other modules. This is the "nuclear option" that
            works regardless of DOM structure changes.
            
            Why this works:
            1. CSS is applied after all templates are rendered
            2. !important overrides any conflicting styles
            3. Targets elements by class and context, not specific DOM structure
            4. Works even if other modules change HTML structure
            -->
            <xpath expr="//div[@class='page']" position="inside">
                <style>
                    /* HIDE DOCUMENT TITLE IN BODY (already in header) */
                    /* Targets the first h2 in article section which is typically the doc title */
                    .article h2:first-of-type { display: none !important; }
                    
                    /* HIDE PARTNER ADDRESS DISPLAYS (already in header) */
                    /* These target common address elements from various modules */
                    .o_report_layout_spacey .address { display: none !important; }
                    .o_report_layout_spacey t[name="partner_header"] { display: none !important; }
                    
                    /* ENSURE OUR INFORMATION SECTION STYLING IS PRESERVED */
                    /* Reinforces our custom information section styling */
                    .o_report_layout_spacey #informations {
                        border-top: 1px solid #2C5282;
                        border-bottom: 1px solid #2C5282;
                        padding: 12px 0;
                        margin: 16px 0;
                    }
                </style>
            </xpath>
            
        </template>
        
    </data>
</odoo>